<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCP Category Selector Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-text {
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            user-select: text;
        }
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        .btn {
            background: #ef4444;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn:hover {
            background: #dc2626;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .debug-log {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ§ª RCP Category Selector Test</h1>
        
        <div class="instructions">
            <strong>Test Instructions:</strong>
            <ol>
                <li>Highlight some text in the box below</li>
                <li>Click "Test Save Selection" button</li>
                <li>Check if the category selector modal appears</li>
                <li>Verify that existing categories are loaded</li>
                <li>Try creating a new category</li>
                <li>Try saving the prompt</li>
            </ol>
        </div>

        <div class="test-text" id="testText">
            This is a test text for the RCP extension. Highlight this text and click the "Test Save Selection" button to test the category selector functionality. The category selector should appear and show existing categories, allow you to create new ones, and save the selected text as a prompt.
        </div>

        <button class="btn" onclick="testSaveSelection()">Test Save Selection</button>
        <button class="btn" onclick="clearLog()" style="background: #6b7280;">Clear Log</button>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div class="debug-log" id="debugLog">
            <div>=== Debug Log Started ===</div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #9ca3af;">[${timestamp}]</span> <span style="color: ${type === 'error' ? '#f87171' : type === 'success' ? '#4ade80' : '#60a5fa'}">${message}</span>`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[RCP Test] ${message}`);
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            log(`Status: ${message}`, type);
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function clearLog() {
            const logDiv = document.getElementById('debugLog');
            logDiv.innerHTML = '<div>=== Debug Log Cleared ===</div>';
        }

        async function testSaveSelection() {
            log('Starting save selection test...');
            
            // Check if extension is available
            if (typeof browser === 'undefined') {
                showStatus('Browser API not available. Make sure the extension is installed and running.', 'error');
                log('Browser API not available', 'error');
                return;
            }

            if (!browser.runtime) {
                showStatus('Extension runtime not available. Make sure the extension is properly installed.', 'error');
                log('Extension runtime not available', 'error');
                return;
            }

            try {
                // Get selected text
                const selection = window.getSelection();
                const selectedText = selection ? selection.toString().trim() : '';
                
                if (!selectedText) {
                    showStatus('Please highlight some text in the test area first.', 'error');
                    log('No text selected', 'error');
                    return;
                }

                log(`Selected text: "${selectedText.substring(0, 50)}${selectedText.length > 50 ? '...' : ''}"`);

                // Store the selected text temporarily
                await browser.storage.local.set({ 
                    pendingPromptText: selectedText,
                    pendingPromptSource: 'test'
                });

                log('Stored pending prompt in storage');

                // Check if we can get folders
                const folderResponse = await browser.runtime.sendMessage({ action: 'getFolders' });
                log(`Get folders response: ${JSON.stringify(folderResponse)}`);

                if (folderResponse && folderResponse.success) {
                    log(`Successfully loaded ${folderResponse.folders.length} folders`);
                    showStatus(`Found ${folderResponse.folders.length} folders. Now testing category selector...`, 'success');
                } else {
                    log(`Failed to get folders: ${JSON.stringify(folderResponse)}`, 'error');
                    showStatus('Failed to load folders from extension.', 'error');
                    return;
                }

                // Inject the category selector
                log('Injecting category selector script...');
                await browser.scripting.executeScript({
                    target: { tabId: (await browser.tabs.query({ active: true, currentWindow: true }))[0].id },
                    files: ['category-selector.js']
                });

                log('Category selector script injected successfully');
                showStatus('Category selector should now appear on the page!', 'success');

            } catch (error) {
                console.error('Error in test:', error);
                showStatus(`Error: ${error.message}`, 'error');
                log(`Error: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Test page loaded');
            
            // Check if extension is available
            if (typeof browser !== 'undefined' && browser.runtime) {
                log('Extension context detected');
                
                // Try to ping the extension
                browser.runtime.sendMessage({ action: 'ping' }).then(response => {
                    log(`Extension ping response: ${JSON.stringify(response)}`);
                }).catch(error => {
                    log(`Extension ping failed: ${error.message}`, 'error');
                });
            } else {
                log('Extension context not detected', 'error');
            }
        });

        // Listen for extension messages
        if (typeof browser !== 'undefined' && browser.runtime) {
            browser.runtime.onMessage.addListener((message, sender, sendResponse) => {
                log(`Received message from extension: ${JSON.stringify(message)}`);
            });
        }
    </script>
</body>
</html>